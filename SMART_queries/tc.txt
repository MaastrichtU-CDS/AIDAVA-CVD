PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX aidava: <https://biomedit.ch/rdf/sphn-ontology/AIDAVA/>
PREFIX sphn: <https://biomedit.ch/rdf/sphn-ontology/sphn#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX snomed: <http://snomed.info/id/>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX sphn-loinc: <https://biomedit.ch/rdf/sphn-resource/loinc/>
PREFIX atc: <https://www.whocc.no/atc_ddd_index/?code=>
SELECT DISTINCT ?patient ?tCholesterol ?tcUnit (GROUP_CONCAT(DISTINCT ?tCholesterol_source; SEPARATOR="; ") AS ?tCholesterol_sources) 
WHERE { 
    # To aplly a given URI this can be used: 
    VALUES ?patient {<https://rdf.aidava.eu/resource/Patient/30>}    
    
    ?g <http://rdf.aidava.eu/metadata#belongsTo> ?patient .
    
    #Current date and year
    BIND(now() AS ?currentDateTime) .
    BIND(YEAR(?currentDateTime) AS ?currentYear)
    
    #totalCholesterol
    OPTIONAL {
        VALUES ?tcTestCode {sphn-loinc:14647-2}
        ?tc aidava:hasPatient ?patient .
		?tc rdf:type sphn:Measurement .   
    	?tc sphn:hasLabTest ?tcTest . 
    	?tcTest sphn:hasCode ?tcTestCode .
    	?tc sphn:hasQuantity ?tcQuantity .
        # extract source graph
        GRAPH ?tCholesterol_source {
    		?tcQuantity sphn:hasValue ?tc_value .
    		?tcQuantity sphn:hasUnit ?tcUnitObject .
    		?tcUnitObject sphn:hasCode ?tcUnitCode .
        }
    	?tcUnitCode rdfs:label ?tc_unit .  
        OPTIONAL {?tc sphn:hasMeasurementDateTime ?tcDateTime .} 
        {
            SELECT (MAX(?tcDateTime) AS ?max_tcDateTime)
            WHERE {
            	VALUES ?tcTestCode {sphn-loinc:14647-2}
        		?tc aidava:hasPatient ?patient .
				?tc rdf:type sphn:Measurement .   
    			?tc sphn:hasLabTest ?tcTest . 
    			?tcTest sphn:hasCode ?tcTestCode .
                OPTIONAL {?tc sphn:hasMeasurementDateTime ?tcDateTime .}
        	} 
        }        
        FILTER(?tcDateTime = ?max_tcDateTime)
    }
    BIND(IF(BOUND(?tc_value), ?tc_value, 4.9) AS ?tCholesterol)
    BIND(IF(BOUND(?tc_unit), ?tc_unit, "mmol/L") AS ?tcUnit)
   
} 
GROUP BY ?patient ?tCholesterol ?tcUnit 
